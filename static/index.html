<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>pileUp</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    html, body, #stream { margin: 0; padding: 0; width: 100%; height: 100% }
    nav { width: 100%; background: black; color:white; height: 50px; }
    nav img { margin-left:10px; height: 50px; }
    #stream { position:absolute; left:0; top:50px; background: #0e3f4c; width:400px; height: calc(100% - 50px); }
    #notepad { background: #0a2834; padding:10px; margin: 5px;}
    #posts { background: #0a2834; margin:5px; padding:10px;}
    #posts p { min-height: 30px; background: aliceblue; padding:10px; }
    #posts p.dragging { background: white; opacity: 50% }
    #canvas { position: absolute; left:400px; width: calc(100% - 400px); top: 50px; background: cadetblue;
        height: calc(100% - 50px ); }
    .pile rect { fill: bisque; filter: drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4)) }
    .pile rect.droptarget { fill: #bb8749 } /* dummy rule for color skittle in editor */
    .pile-name { font-weight: bold }
    body { font-family: "Calibri" }
    #ghost { position:absolute; left: 0; top:0; width:100px; height: 60px; z-index: 1;
        background: white; border:solid #333 1px; opacity: 90%; display:none;
        box-shadow: #00000033 5px 5px 3px 3px; }
    #crumbs { display: inline-block; padding:0; margin:0; position:relative; top:-15px; }
    #crumbs li { display: inline; }
    #crumbs li:before { content: " â†’ "; font-family: "consolas"; color: white !important; }
    #crumbs li:first-child:before { content: " " }
    #crumbs li:hover, .pile a:hover { cursor: pointer }
  </style>
</head>
<body>

<nav>
  <img src="/static/pileup-logo.svg"/>
  <ul id="crumbs">
  </ul>
</nav>

<div id="stream">
  <form id="notepad">
    <textarea name="text" rows="8" cols="48"></textarea>
    <br/>
    <button type="button" onclick="addScrap()">post</button>
  </form>
  <div id="posts">
  </div>
</div>

<div id="ghost">
</div>

<svg id="canvas">
</svg>

<script>

  let model = {scraps:[], piles:[], pile:null, crumbs:[]}
  let cached = {piles:[]}

  // -- drawing the piles ------------------------------------

  function getPiles() { return d3.select("#canvas").selectAll('g').data(model.piles) }
  function drawPiles() {
    let ofsx = 20, boxw = 300, gapw = 10, cols = 3,
        ofsy = 20, boxh = 180, gaph = 10
    let p = cached.piles = getPiles().join('g').attr('class','pile').attr('transform', (d,i)=>
        `translate(${ofsx+i%cols*(boxw+gapw)},${ofsy+Math.floor(i/cols)*(boxh+gaph)})`)
    p.append('rect').attr('width', boxw).attr('height', boxh)
    p.append('text').attr('class','pile-name').attr('x',10).attr('y',20)
      .append('a').on('click', (e,d)=>gotoPile(d.text)).text(d=>d.text) }

  function ghostToMouse(e,d) {
      return d3.select('#ghost').style('left',
        `${e.sourceEvent.clientX - 10}px`).style('top', `${e.sourceEvent.clientY -25}px`) }

  // -- the inbox --------------------------------------------

  function isOver(elem, e) {
    let r = elem.getBoundingClientRect()
    let ex = e.sourceEvent.clientX, ey = e.sourceEvent.clientY
    return (ex >= r.x && ex - r.x < r.width) && (ey >= r.y && ey - r.y < r.height) }

  function jFetch(url, method, body) {
    var req;
    if (method=='GET' || !method) { req = fetch(url) }
    else { req = fetch(url,
      {method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)}) }
    return req.then(res=>res.json()) }

  function drawScraps() {
    let scraps = d3.select('#posts').selectAll('p')
    let newScraps = scraps.data(model.scraps, d=>d._id).join('p').html(d=>d.text)
    newScraps.call(d3.drag()
      .on('start', function (e,d){
        d3.select(this).classed('dragging', true)
        ghostToMouse(e,d).style('display','block') })
      .on('drag', (e,d)=>{ ghostToMouse(e,d)
        // now highlight the pile we'd drop to
        cached.piles.select('rect').each(function(d,i){
          d3.select(this).transition().duration(250).ease(d3.easeLinear)
            .style('fill', isOver(this, e) ? '#bb8749' : '') }) })
      .on('end', function (e, d, i){
        let el = d3.select(this).classed('dragging', false)
        d3.select('#ghost').style('display','none')
        cached.piles.select('rect').transition().duration(250).ease(d3.easeLinear).style('fill', '')
        let target = cached.piles.select('rect').filter(function(){return isOver(this, e)})
        if (target.size()) { // -- dragged scrap to a pile
          let pile = target.data()[0];
          jFetch(`/s/${d._id}`, 'PUT', {pile: pile._id})
          model.scraps.pop(i)
          el.remove() } })) }

  function addScrap() {
    let text = document.getElementById('notepad').text.value;
    jFetch('/p/@inbox', 'POST', {text}).then(res=>{
      model.scraps.unshift({_id: res._id, text})
      drawScraps() }) }

  function drawCrumbs() {
    d3.select('#crumbs').selectAll('li').data(model.crumbs).join('li').text(d=>d)
      .on('click', (e,d) => { if (d != model.pile) gotoPile(d) })}

  function gotoPile(which) {
    if (which != model.pile) {
      let ix = model.crumbs.indexOf(which)
      if (ix > -1) { model.crumbs = model.crumbs.slice(0, ix + 1) } // jump to crumb
      else { model.crumbs.push(which) }
      model.pile = which
      drawCrumbs() }
    model.scraps = []; model.piles = [];
    jFetch(`/p/${which}`).then(data=>{
        for (var item of data) {
          switch(item.type) {
            case 'pile': model.piles.push(item); break;
            default: model.scraps.push(item) }}
        drawPiles(); drawScraps() }) }

  // -- begin ------------------------------------------------

  gotoPile(document.location.hash.substr(1) || '@inbox')

</script>
</body>
</html>
