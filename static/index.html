<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>pileUp</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    html, body, #stream { margin: 0; padding: 0; width: 100%; height: 100% }
    nav { width: 100%; background: black; height: 50px; }
    nav img { margin-left:10px; height: 50px; }
    #stream { position:absolute; left:0; top:50px; background: #0e3f4c; width:400px; height: calc(100% - 50px); }
    #notepad { background: #0a2834; padding:10px; margin: 5px;}
    #posts { background: #0a2834; margin:5px; padding:10px;}
    #posts p { min-height: 30px; background: aliceblue; padding:10px; }
    #posts p.dragging { background: white; opacity: 50% }
    #canvas { position: absolute; left:400px; width: calc(100% - 400px); top: 50px; background: cadetblue;
        height: calc(100% - 50px ); }
    .pile rect { fill: bisque; filter: drop-shadow(3px 5px 2px rgb(0 0 0 / 0.4)) }
    .pile rect.droptarget { fill: #bb8749 } /* dummy rule for color skittle in editor */
    .pile-name { font-weight: bold }
    body { font-family: "Calibri" }
    #target { position:absolute; left: 0; top:0; width:100px; height: 60px; z-index: 1;
        background: white; border:solid #333 1px; opacity: 90%; display:none;
        box-shadow: #00000033 5px 5px 3px 3px; }
  </style>
</head>
<body>

<nav>
  <img src="/static/pileup-logo.svg"/>
</nav>

<div id="stream">
  <form id="notepad">
    <textarea name="text" rows="8" cols="48"></textarea>
    <br/>
    <button type="button" onclick="addScrap()">post</button>
  </form>
  <div id="posts">
  </div>
</div>

<div id="target">
</div>

<svg id="canvas">

</svg>

<script>

  let model = {scraps:[], piles:['one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine']}

  // -- drawing the piles --
  let ofsx = 20, boxw = 300, gapw = 10, cols = 3,
      ofsy = 20, boxh = 180, gaph = 10

  let piles = d3.select("#canvas").selectAll('g').data(model.piles)
    .enter().append('g').attr('class','pile').attr('transform', (d,i)=>
      `translate(${ofsx+i%cols*(boxw+gapw)},${ofsy+Math.floor(i/cols)*(boxh+gaph)})`)
  piles.append('rect').attr('width', boxw).attr('height', boxh)
  piles.append('text').attr('class','pile-name').attr('x',10).attr('y',20).text(d=>d)

  function targetToMouse(e,d) {
      return d3.select('#target').style('left',
        `${e.sourceEvent.clientX - 10}px`).style('top', `${e.sourceEvent.clientY -25}px`) }


  // -- the inbox -------

  function drawScraps() {
    let scraps = d3.select('#posts').selectAll('p')
    let newScraps = scraps.data(model.scraps, d=>d._id).enter().append('p').html(d=>d.text)
    newScraps.call(d3.drag()
      .on('start', function (e,d){
        d3.select(this).classed('dragging', true)
        targetToMouse(e,d).style('display','block') })
      .on('drag', (e,d)=>{ targetToMouse(e,d)
        // now highlight the pile we'd drop to
        piles.select('rect').each(function(d,i){
          let r = this.getBoundingClientRect()
          let ex = e.sourceEvent.clientX, ey = e.sourceEvent.clientY
          let over = (ex >= r.x && ex - r.x < r.width) && (ey >= r.y && ey - r.y < r.height)
          d3.select(this).transition().duration(250).ease(d3.easeLinear).style('fill', over ? '#bb8749' : '') }) })
      .on('end', function (e,d ){
          console.log('endin.')
        d3.select(this).classed('dragging', false)
        d3.select('#target').style('display','none')
        piles.select('rect').transition().duration(250).ease(d3.easeLinear).style('fill', '')})) }

  fetch('/inbox').then(r=>r.json()).then(data=>{ model.scraps = data; drawScraps() })

  function addScrap() {
    let text = document.getElementById('notepad').text.value;
    fetch('/inbox',
      {method:'POST', headers: { 'Content-Type': 'application/json'},
      body: JSON.stringify({text}) })
    .then(r=>r.json()).then(res=>{
      model.scraps.unshift({_id: res._id, text})
      drawScraps() }) }

</script>
</body>
</html>
